{"ast":null,"code":"import _extends from \"@babel/runtime/helpers/extends\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport { isString } from '@react-native-firebase/app/lib/common';\nimport NativeError from '@react-native-firebase/app/lib/internal/NativeFirebaseError';\nimport SharedEventEmitter from '@react-native-firebase/app/lib/internal/SharedEventEmitter';\nimport NativeModules from \"react-native-web/dist/exports/NativeModules\";\nimport DatabaseDataSnapshot from \"./DatabaseDataSnapshot\";\n\nvar DatabaseSyncTree = function () {\n  function DatabaseSyncTree() {\n    _classCallCheck(this, DatabaseSyncTree);\n\n    this._tree = {};\n    this._reverseLookup = {};\n    SharedEventEmitter.addListener('database_sync_event', this._handleSyncEvent.bind(this));\n  }\n\n  _createClass(DatabaseSyncTree, [{\n    key: \"native\",\n    get: function get() {\n      return NativeModules.RNFBDatabaseQueryModule;\n    }\n  }, {\n    key: \"_handleSyncEvent\",\n    value: function _handleSyncEvent(event) {\n      var body = event.body;\n\n      if (body.error) {\n        this._handleErrorEvent(body);\n      } else {\n        this._handleValueEvent(body);\n      }\n    }\n  }, {\n    key: \"_handleErrorEvent\",\n    value: function _handleErrorEvent(event) {\n      var _event$registration = event.registration,\n          eventRegistrationKey = _event$registration.eventRegistrationKey,\n          registrationCancellationKey = _event$registration.registrationCancellationKey;\n      var registration = this.getRegistration(registrationCancellationKey);\n\n      if (registration) {\n        var error = NativeError.fromEvent(event.error, 'database');\n        SharedEventEmitter.emit(registrationCancellationKey, error);\n        this.removeRegistration(eventRegistrationKey);\n      }\n    }\n  }, {\n    key: \"_handleValueEvent\",\n    value: function _handleValueEvent(event) {\n      var _event$registration2 = event.registration,\n          key = _event$registration2.key,\n          eventRegistrationKey = _event$registration2.eventRegistrationKey;\n      var registration = this.getRegistration(eventRegistrationKey);\n\n      if (!registration) {\n        return this.native.off(key, eventRegistrationKey);\n      }\n\n      var snapshot;\n      var previousChildName;\n\n      if (event.eventType === 'value') {\n        snapshot = new DatabaseDataSnapshot(registration.ref, event.data);\n      } else {\n        snapshot = new DatabaseDataSnapshot(registration.ref, event.data.snapshot);\n        previousChildName = event.data.previousChildName;\n      }\n\n      return SharedEventEmitter.emit(eventRegistrationKey, snapshot, previousChildName);\n    }\n  }, {\n    key: \"getRegistration\",\n    value: function getRegistration(registration) {\n      return this._reverseLookup[registration] ? _extends({}, this._reverseLookup[registration]) : null;\n    }\n  }, {\n    key: \"removeListenersForRegistrations\",\n    value: function removeListenersForRegistrations(registrations) {\n      if (isString(registrations)) {\n        this.removeRegistration(registrations);\n        SharedEventEmitter.removeAllListeners(registrations);\n        return 1;\n      }\n\n      if (!Array.isArray(registrations)) {\n        return 0;\n      }\n\n      for (var i = 0, len = registrations.length; i < len; i++) {\n        this.removeRegistration(registrations[i]);\n        SharedEventEmitter.removeAllListeners(registrations[i]);\n      }\n\n      return registrations.length;\n    }\n  }, {\n    key: \"removeListenerRegistrations\",\n    value: function removeListenerRegistrations(listener, registrations) {\n      if (!Array.isArray(registrations)) {\n        return [];\n      }\n\n      var removed = [];\n\n      for (var i = 0, len = registrations.length; i < len; i++) {\n        var registration = registrations[i];\n\n        var subscriptions = SharedEventEmitter._subscriber.getSubscriptionsForType(registration);\n\n        if (subscriptions) {\n          for (var j = 0, l = subscriptions.length; j < l; j++) {\n            var subscription = subscriptions[j];\n\n            if (subscription && subscription.listener === listener) {\n              subscription.remove();\n              removed.push(registration);\n              this.removeRegistration(registration);\n            }\n          }\n        }\n      }\n\n      return removed;\n    }\n  }, {\n    key: \"getRegistrationsByPath\",\n    value: function getRegistrationsByPath(path) {\n      var out = [];\n      var eventKeys = Object.keys(this._tree[path] || {});\n\n      for (var i = 0, len = eventKeys.length; i < len; i++) {\n        Array.prototype.push.apply(out, Object.keys(this._tree[path][eventKeys[i]]));\n      }\n\n      return out;\n    }\n  }, {\n    key: \"getRegistrationsByPathEvent\",\n    value: function getRegistrationsByPathEvent(path, eventType) {\n      if (!this._tree[path]) {\n        return [];\n      }\n\n      if (!this._tree[path][eventType]) {\n        return [];\n      }\n\n      return Object.keys(this._tree[path][eventType]);\n    }\n  }, {\n    key: \"getOneByPathEventListener\",\n    value: function getOneByPathEventListener(path, eventType, listener) {\n      if (!this._tree[path]) {\n        return null;\n      }\n\n      if (!this._tree[path][eventType]) {\n        return null;\n      }\n\n      var registrationsForPathEvent = Object.entries(this._tree[path][eventType]);\n\n      for (var i = 0; i < registrationsForPathEvent.length; i++) {\n        var registration = registrationsForPathEvent[i];\n\n        if (registration[1] === listener) {\n          return registration[0];\n        }\n      }\n\n      return null;\n    }\n  }, {\n    key: \"addRegistration\",\n    value: function addRegistration(registration) {\n      var _this = this;\n\n      var eventRegistrationKey = registration.eventRegistrationKey,\n          eventType = registration.eventType,\n          listener = registration.listener,\n          once = registration.once,\n          path = registration.path;\n\n      if (!this._tree[path]) {\n        this._tree[path] = {};\n      }\n\n      if (!this._tree[path][eventType]) {\n        this._tree[path][eventType] = {};\n      }\n\n      this._tree[path][eventType][eventRegistrationKey] = listener;\n      this._reverseLookup[eventRegistrationKey] = registration;\n\n      if (once) {\n        var subscription = SharedEventEmitter.addListener(eventRegistrationKey, function (event) {\n          _this._onOnceRemoveRegistration(eventRegistrationKey, listener)(event);\n\n          subscription.remove();\n        });\n      } else {\n        SharedEventEmitter.addListener(eventRegistrationKey, listener);\n      }\n\n      return eventRegistrationKey;\n    }\n  }, {\n    key: \"removeRegistration\",\n    value: function removeRegistration(registration) {\n      if (!this._reverseLookup[registration]) {\n        return false;\n      }\n\n      var _this$_reverseLookup$ = this._reverseLookup[registration],\n          path = _this$_reverseLookup$.path,\n          eventType = _this$_reverseLookup$.eventType,\n          once = _this$_reverseLookup$.once;\n\n      if (!this._tree[path]) {\n        delete this._reverseLookup[registration];\n        return false;\n      }\n\n      if (!this._tree[path][eventType]) {\n        delete this._reverseLookup[registration];\n        return false;\n      }\n\n      var registrationObj = this._reverseLookup[registration];\n\n      if (registrationObj && !once) {\n        this.native.off(registrationObj.key, registration);\n      }\n\n      delete this._tree[path][eventType][registration];\n      delete this._reverseLookup[registration];\n      return !!registrationObj;\n    }\n  }, {\n    key: \"_onOnceRemoveRegistration\",\n    value: function _onOnceRemoveRegistration(registration, listener) {\n      var _this2 = this;\n\n      return function () {\n        _this2.removeRegistration(registration);\n\n        listener.apply(void 0, arguments);\n      };\n    }\n  }]);\n\n  return DatabaseSyncTree;\n}();\n\nexport default new DatabaseSyncTree();","map":{"version":3,"sources":["C:/Users/ABC/Clump/coder/node_modules/@react-native-firebase/database/lib/DatabaseSyncTree.js"],"names":["isString","NativeError","SharedEventEmitter","DatabaseDataSnapshot","DatabaseSyncTree","_tree","_reverseLookup","addListener","_handleSyncEvent","bind","NativeModules","RNFBDatabaseQueryModule","event","body","error","_handleErrorEvent","_handleValueEvent","registration","eventRegistrationKey","registrationCancellationKey","getRegistration","fromEvent","emit","removeRegistration","key","native","off","snapshot","previousChildName","eventType","ref","data","registrations","removeAllListeners","Array","isArray","i","len","length","listener","removed","subscriptions","_subscriber","getSubscriptionsForType","j","l","subscription","remove","push","path","out","eventKeys","Object","keys","prototype","apply","registrationsForPathEvent","entries","once","_onOnceRemoveRegistration","registrationObj"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2016-present Invertase Limited & Contributors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this library except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nimport { isString } from '@react-native-firebase/app/lib/common';\nimport NativeError from '@react-native-firebase/app/lib/internal/NativeFirebaseError';\nimport SharedEventEmitter from '@react-native-firebase/app/lib/internal/SharedEventEmitter';\nimport { NativeModules } from 'react-native';\nimport DatabaseDataSnapshot from './DatabaseDataSnapshot';\n\nclass DatabaseSyncTree {\n  constructor() {\n    this._tree = {};\n    this._reverseLookup = {};\n\n    SharedEventEmitter.addListener('database_sync_event', this._handleSyncEvent.bind(this));\n  }\n\n  get native() {\n    return NativeModules.RNFBDatabaseQueryModule;\n  }\n\n  /**\n   * Handles an incoming event from native\n   * @param event\n   * @private\n   */\n  _handleSyncEvent(event) {\n    const { body } = event;\n    if (body.error) {\n      this._handleErrorEvent(body);\n    } else {\n      this._handleValueEvent(body);\n    }\n  }\n\n  /**\n   * Routes native database query listener cancellation events to their js counterparts.\n   *\n   * @param event\n   * @private\n   */\n  _handleErrorEvent(event) {\n    // console.log('SyncTree.ERROR >>>', event);\n    const { eventRegistrationKey, registrationCancellationKey } = event.registration;\n\n    const registration = this.getRegistration(registrationCancellationKey);\n\n    if (registration) {\n      // build a new js error - we additionally attach\n      // the ref as a property for easier debugging\n      const error = NativeError.fromEvent(event.error, 'database');\n\n      // forward on to users .on(successCallback, cancellationCallback <-- listener\n      SharedEventEmitter.emit(registrationCancellationKey, error);\n\n      // remove the paired event registration - if we received a cancellation\n      // event then it's guaranteed that they'll be no further value events\n      this.removeRegistration(eventRegistrationKey);\n    }\n  }\n\n  /**\n   * Routes native database 'on' events to their js equivalent counterpart.\n   * If t is no longer any listeners remaining for this event we internally\n   * call the native unsub method to prevent further events coming through.\n   *\n   * @param event\n   * @private\n   */\n  _handleValueEvent(event) {\n    // console.log('SyncTree.VALUE >>>', event);\n    const { key, eventRegistrationKey } = event.registration;\n    const registration = this.getRegistration(eventRegistrationKey);\n    // console.log('SyncTree.registration >>>', registration);\n\n    if (!registration) {\n      // registration previously revoked\n      // notify native that the registration\n      // no longer exists so it can remove\n      // the native listeners\n      return this.native.off(key, eventRegistrationKey);\n    }\n\n    let snapshot;\n    let previousChildName;\n\n    // Value events don't return a previousChildName\n    if (event.eventType === 'value') {\n      snapshot = new DatabaseDataSnapshot(registration.ref, event.data);\n    } else {\n      snapshot = new DatabaseDataSnapshot(registration.ref, event.data.snapshot);\n      previousChildName = event.data.previousChildName;\n    }\n\n    // forward on to users .on(successCallback <-- listener\n    return SharedEventEmitter.emit(eventRegistrationKey, snapshot, previousChildName);\n  }\n\n  /**\n   * Returns registration information such as appName, ref, path and registration keys.\n   *\n   * @param registration\n   * @return {null}\n   */\n  getRegistration(registration) {\n    return this._reverseLookup[registration]\n      ? Object.assign({}, this._reverseLookup[registration])\n      : null;\n  }\n\n  /**\n   * Removes all listeners for the specified registration keys.\n   *\n   * @param registrations\n   * @return {number}\n   */\n  removeListenersForRegistrations(registrations) {\n    if (isString(registrations)) {\n      this.removeRegistration(registrations);\n      SharedEventEmitter.removeAllListeners(registrations);\n      return 1;\n    }\n\n    if (!Array.isArray(registrations)) {\n      return 0;\n    }\n    for (let i = 0, len = registrations.length; i < len; i++) {\n      this.removeRegistration(registrations[i]);\n      SharedEventEmitter.removeAllListeners(registrations[i]);\n    }\n\n    return registrations.length;\n  }\n\n  /**\n   * Removes a specific listener from the specified registrations.\n   *\n   * @param listener\n   * @param registrations\n   * @return {Array} array of registrations removed\n   */\n  removeListenerRegistrations(listener, registrations) {\n    if (!Array.isArray(registrations)) {\n      return [];\n    }\n    const removed = [];\n\n    for (let i = 0, len = registrations.length; i < len; i++) {\n      const registration = registrations[i];\n      const subscriptions = SharedEventEmitter._subscriber.getSubscriptionsForType(registration);\n\n      if (subscriptions) {\n        for (let j = 0, l = subscriptions.length; j < l; j++) {\n          const subscription = subscriptions[j];\n          // The subscription may have been removed during this event loop.\n          // its listener matches the listener in method parameters\n          if (subscription && subscription.listener === listener) {\n            subscription.remove();\n            removed.push(registration);\n            this.removeRegistration(registration);\n          }\n        }\n      }\n    }\n\n    return removed;\n  }\n\n  /**\n   * Returns an array of all registration keys for the specified path.\n   *\n   * @param path\n   * @return {Array}\n   */\n  getRegistrationsByPath(path) {\n    const out = [];\n    const eventKeys = Object.keys(this._tree[path] || {});\n\n    for (let i = 0, len = eventKeys.length; i < len; i++) {\n      Array.prototype.push.apply(out, Object.keys(this._tree[path][eventKeys[i]]));\n    }\n\n    return out;\n  }\n\n  /**\n   * Returns an array of all registration keys for the specified path and eventType.\n   *\n   * @param path\n   * @param eventType\n   * @return {Array}\n   */\n  getRegistrationsByPathEvent(path, eventType) {\n    if (!this._tree[path]) {\n      return [];\n    }\n    if (!this._tree[path][eventType]) {\n      return [];\n    }\n\n    return Object.keys(this._tree[path][eventType]);\n  }\n\n  /**\n   * Returns a single registration key for the specified path, eventType, and listener\n   *\n   * @param path\n   * @param eventType\n   * @param listener\n   * @return {Array}\n   */\n  getOneByPathEventListener(path, eventType, listener) {\n    if (!this._tree[path]) {\n      return null;\n    }\n    if (!this._tree[path][eventType]) {\n      return null;\n    }\n\n    const registrationsForPathEvent = Object.entries(this._tree[path][eventType]);\n\n    for (let i = 0; i < registrationsForPathEvent.length; i++) {\n      const registration = registrationsForPathEvent[i];\n      if (registration[1] === listener) {\n        return registration[0];\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Register a new listener.\n   *\n   * @param registration\n   */\n  addRegistration(registration) {\n    const { eventRegistrationKey, eventType, listener, once, path } = registration;\n\n    if (!this._tree[path]) {\n      this._tree[path] = {};\n    }\n    if (!this._tree[path][eventType]) {\n      this._tree[path][eventType] = {};\n    }\n\n    this._tree[path][eventType][eventRegistrationKey] = listener;\n    this._reverseLookup[eventRegistrationKey] = registration;\n\n    if (once) {\n      const subscription = SharedEventEmitter.addListener(eventRegistrationKey, event => {\n        this._onOnceRemoveRegistration(eventRegistrationKey, listener)(event);\n        subscription.remove();\n      });\n    } else {\n      SharedEventEmitter.addListener(eventRegistrationKey, listener);\n    }\n\n    return eventRegistrationKey;\n  }\n\n  /**\n   * Remove a registration, if it's not a `once` registration then instructs native\n   * to also remove the underlying database query listener.\n   *\n   * @param registration\n   * @return {boolean}\n   */\n  removeRegistration(registration) {\n    if (!this._reverseLookup[registration]) {\n      return false;\n    }\n    const { path, eventType, once } = this._reverseLookup[registration];\n\n    if (!this._tree[path]) {\n      delete this._reverseLookup[registration];\n      return false;\n    }\n\n    if (!this._tree[path][eventType]) {\n      delete this._reverseLookup[registration];\n      return false;\n    }\n\n    // we don't want `once` events to notify native as they're already\n    // automatically unsubscribed on native when the first event is sent\n    const registrationObj = this._reverseLookup[registration];\n    if (registrationObj && !once) {\n      this.native.off(registrationObj.key, registration);\n    }\n\n    delete this._tree[path][eventType][registration];\n    delete this._reverseLookup[registration];\n\n    return !!registrationObj;\n  }\n\n  /**\n   * Wraps a `once` listener with a new function that self de-registers.\n   *\n   * @param registration\n   * @param listener\n   * @return {function(...[*])}\n   * @private\n   */\n  _onOnceRemoveRegistration(registration, listener) {\n    return (...args) => {\n      this.removeRegistration(registration);\n      listener(...args);\n    };\n  }\n}\n\nexport default new DatabaseSyncTree();\n"]},"metadata":{},"sourceType":"module"}